name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Secrets
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "❌ エラー: SSH_PRIVATE_KEYが設定されていません"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "❌ エラー: SSH_HOSTが設定されていません"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "❌ エラー: SSH_USERが設定されていません"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
            echo "❌ エラー: DEPLOY_PATHが設定されていません"
            exit 1
          fi
          echo "✅ すべてのSecretsが設定されています"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>&1 || true

      - name: Test SSH connection
        run: |
          echo "SSH接続をテスト中..."
          ssh -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH接続成功！' || exit 1"

      - name: Deploy to server
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          set -e
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SSH_USER@$SSH_HOST bash << 'REMOTE_SCRIPT' || {
            echo "❌ SSHコマンド実行でエラーが発生しました"
            exit 1
          }
            set -e
            set -x  # デバッグモードを有効化
            
            DEPLOY_PATH="$DEPLOY_PATH"
            
            echo "=========================================="
            echo "デプロイを開始します"
            echo "DEPLOY_PATH: $DEPLOY_PATH"
            echo "現在のユーザー: $(whoami)"
            echo "現在のディレクトリ: $(pwd)"
            echo "=========================================="
            
            if [ -z "$DEPLOY_PATH" ]; then
              echo "❌ エラー: DEPLOY_PATHが設定されていません"
              exit 1
            fi
            
            echo "=== デプロイ先ディレクトリ: $DEPLOY_PATH ==="
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "❌ エラー: ディレクトリが存在しません: $DEPLOY_PATH"
              exit 1
            fi
            
            cd "$DEPLOY_PATH" || {
              echo "❌ エラー: ディレクトリに移動できません: $DEPLOY_PATH"
              echo "現在のディレクトリ: $(pwd)"
              echo "ディレクトリの存在確認:"
              ls -la "$(dirname "$DEPLOY_PATH")" || true
              exit 1
            }
            
            echo "=== 現在のディレクトリ: $(pwd) ==="
            
            echo "=== Gitから最新のコードを取得 ==="
            if ! command -v git &> /dev/null; then
              echo "❌ エラー: gitコマンドが見つかりません"
              exit 1
            fi
            
            git fetch origin || {
              echo "❌ git fetch失敗"
              echo "リモート設定を確認中..."
              git remote -v || true
              exit 1
            }
            
            git reset --hard origin/main || {
              echo "❌ git reset失敗"
              echo "現在のブランチ: $(git branch --show-current || echo '不明')"
              exit 1
            }
            
            echo "=== 依存関係のインストール ==="
            if ! command -v composer &> /dev/null; then
              echo "❌ エラー: composerコマンドが見つかりません"
              exit 1
            fi
            
            composer install --no-dev --optimize-autoloader || {
              echo "❌ composer install失敗"
              composer --version || true
              exit 1
            }
            
            if ! command -v npm &> /dev/null; then
              echo "❌ エラー: npmコマンドが見つかりません"
              exit 1
            fi
            
            npm ci || {
              echo "❌ npm ci失敗"
              npm --version || true
              exit 1
            }
            
            echo "=== フロントエンドのビルド ==="
            npm run build || {
              echo "❌ npm run build失敗"
              echo "package.jsonの内容を確認中..."
              cat package.json | head -20 || true
              exit 1
            }
            
            echo "=== Laravel設定のキャッシュ ==="
            php artisan config:cache || echo "⚠️ config:cache失敗（続行）"
            php artisan route:cache || echo "⚠️ route:cache失敗（続行）"
            php artisan view:cache || echo "⚠️ view:cache失敗（続行）"
            
            echo "=== Dockerコンテナの再起動 ==="
            if [ -f docker-compose.yml ]; then
              if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
                echo "⚠️ docker-composeコマンドが見つかりません。スキップします。"
              else
                docker-compose down || docker compose down || echo "⚠️ docker-compose down失敗（続行）"
                docker-compose up -d --build || docker compose up -d --build || {
                  echo "❌ docker-compose up失敗"
                  exit 1
                }
              fi
            else
              echo "⚠️ docker-compose.ymlが見つかりません。スキップします。"
            fi
            
            echo "=== 権限の設定 ==="
            [ -d storage ] && chmod -R 755 storage || echo "⚠️ storageディレクトリがありません"
            [ -d bootstrap/cache ] && chmod -R 755 bootstrap/cache || echo "⚠️ bootstrap/cacheディレクトリがありません"
            
            echo "=========================================="
            echo "✅ デプロイが完了しました"
            echo "=========================================="
          REMOTE_SCRIPT
        
      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ デプロイが正常に完了しました"
          else
            echo "❌ デプロイが失敗しました"
          fi

